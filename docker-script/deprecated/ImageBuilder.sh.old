#!/bin/bash

jupyter="y"
gispy="y"
SHORT=J:,j:,G:,g:,h
LONG=JUPYTER:,jupyter:,GISPY:,gispy:,help
OPTS=$(getopt -a -n test --options $SHORT --longoptions $LONG -- "$@")
eval set -- "$OPTS"
while :
do
  case "$1" in
    -J | --JUPYTER )
      jupyter="$2"
      shift 2
      ;;
    -j | --jupyter )
      jupyter="$2"
      shift 2
      ;;
    -g | --GISPY )
      gispy="$2"
      shift 2
      ;;
    -g | --gispy )
      gispy="$2"
      shift 2
      ;;
    -h | --help)
      echo -e "This is a script to build docker-isis-asp + jupyter:
            \n-j to install jupyter - default: $jupyter
            \n-g to install gispy - default: $gispy"
      exit 2
      ;;
    --)
      shift;
      break
      ;;
    *)
      echo "Unexpected option, using defaults"
      break
      ;;
  esac
done

ASP_VERSION='3.0.0'
ISIS_VERSION='5'
GDAL_VERSION='3.4.1'
JUPYTER_ENABLE_LAB='yes'
DOCKERFILE=isis5-asp.dockerfile
GISPY_DOCKERFILE=gispy.dockerfile

echo "ISIS version $ISIS_VERSION will be installed"
echo "NASA_Ames Stereo Pipeline 3.0.0 will be installed"
echo "Jupyter install: $jupyter"
echo "GISpy install: $gispy"
read -p "Continue? " -n 1 -r

if [[ $REPLY =~ ^[Yy]$ ]]
  then
    BASE_IMAGE="osgeo/gdal:ubuntu-full-$GDAL_VERSION"
    ISIS_IMAGE="isis5-asp3:latest"

    if [[ $jupyter =~ ^[Yy1]$ ]]
      then
        BASE_IMAGE="osgeo/gdal:ubuntu-full-$GDAL_VERSION"
        echo "\n-j Creating jupyter:gdal image"
        JUPYTER_IMAGE="jupyter:gdal"
        git clone 'https://github.com/jupyter/docker-stacks.git'
        (
        cd docker-stacks
        docker build -t "$JUPYTER_IMAGE"                 \
                --build-arg ROOT_CONTAINER="$BASE_IMAGE" \
                base-notebook/
        )
        [ $? ] && rm -rf docker-stacks && echo "Docker image $OUTPUT_IMAGE built."
        ISIS_IMAGE="isis5-asp3:jupyter"
        BASE_IMAGE=$JUPYTER_IMAGE
      else
        JUPYTER_ENABLE_LAB='no'
    fi

    if [[ $gispy =~ ^[Yy1]$ ]]
      then
        echo "Creating jupyter-gispy:gdal image"
        GISPY_IMAGE="gispy:gdal"
        docker build -t "$GISPY_IMAGE"               \
                --build-arg BASE_IMAGE="$BASE_IMAGE" \
                -f $PWD/dockerfiles/$GISPY_DOCKERFILE .
        BASE_IMAGE=$GISPY_IMAGE
        ISIS_IMAGE="isis5-asp3:gispy"
    fi

    if [[ $jupyter =~ ^[Nn0]$ ]] && [[ $gispy =~ ^[Nn0]$ ]]
      then
        BASE_IMAGE="condaforge/mambaforge"
    fi

    echo "Creating $ISIS_IMAGE image"
    docker build -t "$ISIS_IMAGE"                              \
            --build-arg BASE_IMAGE="$BASE_IMAGE"               \
            --build-arg ISIS_VERSION="$ISIS_VERSION"           \
            --build-arg ASP_VERSION="$ASP_VERSION"             \
            -f $PWD/dockerfiles/$DOCKERFILE .
    [ $? ] && echo "Docker image $ISIS_IMAGE built."
else
    echo "Aborting"
fi
